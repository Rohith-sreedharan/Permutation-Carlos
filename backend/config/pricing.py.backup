"""
BeatVegas Pricing Configuration
NEW 6-TIER SYSTEM: STARTER, BRONZE, SILVER, PLATINUM, FOUNDER, INTERNAL
Universal parlay pricing + tier-based simulation power
"""

from enum import Enum
from typing import Dict, Any

class SubscriptionTier(str, Enum):
    STARTER = "starter"
    BRONZE = "bronze"
    SILVER = "silver"
    PLATINUM = "platinum"
    FOUNDER = "founder"
    INTERNAL = "internal"

# UNIVERSAL PARLAY PRICING (Same for all tiers)
PARLAY_PRICING = {
    "3_leg": 999,   # $9.99 in cents
    "4_leg": 799,   # $7.99
    "5_leg": 599,   # $5.99
    "6_leg": 399    # $3.99
}

# SIMULATION POWER PER TIER
SIMULATION_POWER = {
    "starter": 10_000,      # Free tier
    "bronze": 25_000,
    "silver": 50_000,
    "platinum": 100_000,
    "founder": 100_000,     # Same as Platinum, but gets perks
    "internal": 1_000_000   # House-only, never public
}

# PARLAY ACCESS LEVELS
PARLAY_ACCESS = {
    "starter": "blur_only",    # Sees blurred parlay with upgrade prompt
    "bronze": "full",          # Full generation + viewing, pays normal price
    "silver": "full",
    "platinum": "full",
    "founder": "full",         # Full access + optional lifetime discount
    "internal": "full"
}

# Tier Configuration
TIER_CONFIG: Dict[SubscriptionTier, Dict[str, Any]] = {
    SubscriptionTier.STARTER: {
        "name": "Starter",
        "price_monthly": 0,
        "price_annual": 0,
        "stripe_price_id": None,
        "simulations_per_day": 2,
        "simulations_per_month": 30,
        "iterations": 2000,
        "features": [
            "Basic Monte Carlo simulations",
            "Win probability analysis",
            "Spread distribution",
            "Community access (read-only)"
        ],
        "description": "Get started with basic sports analytics"
    },
    SubscriptionTier.EXPLORER: {
        "name": "Explorer",
        "price_monthly": 19,
        "price_annual": 190,  # ~17% discount
        "stripe_price_id": "price_explorer_monthly",
        "simulations_per_day": 15,
        "simulations_per_month": 450,
        "iterations": 10000,
        "features": [
            "Advanced Monte Carlo simulations",
            "Volatility scoring",
            "Prop bet analysis (Top 5)",
            "Creator Marketplace access",
            "Community participation",
            "Email support"
        ],
        "description": "Advanced analytics for serious sports enthusiasts",
        "founder_price_monthly": 13,  # Discounted for first 300 users
        "founder_price_annual": 130
    },
    SubscriptionTier.PRO: {
        "name": "Pro",
        "price_monthly": 39,
        "price_annual": 390,  # ~17% discount
        "stripe_price_id": "price_pro_monthly",
        "simulations_per_day": 60,
        "simulations_per_month": 1800,
        "iterations": 35000,
        "features": [
            "Premium Monte Carlo simulations",
            "Full Decision Command Center",
            "Parlay Correlation Engine",
            "Cross-sport analysis",
            "Injury impact analysis",
            "Line movement tracking",
            "Creator Intelligence Marketplace",
            "Priority support (24/7)"
        ],
        "description": "Professional-grade analytics suite",
        "founder_price_monthly": 29,  # Discounted for first 300 users
        "founder_price_annual": 290
    },
    SubscriptionTier.ELITE: {
        "name": "Elite",
        "price_monthly": 89,
        "price_annual": 890,  # ~17% discount
        "stripe_price_id": "price_elite_monthly",
        "simulations_per_day": 300,
        "simulations_per_month": 9000,
        "iterations": 100000,
        "features": [
            "Elite Monte Carlo simulations (100K iterations)",
            "Real-time model performance tracking",
            "API access (programmatic)",
            "Custom simulation parameters",
            "Advanced parlay optimization",
            "Multi-sport portfolio analysis",
            "White-glove support (dedicated account manager)",
            "Early access to new features",
            "Quarterly performance reviews"
        ],
        "description": "Ultimate analytics platform for professionals",
        "founder_price_monthly": 69,  # Discounted for first 300 users
        "founder_price_annual": 690
    }
}

# Founder Tier Logic
FOUNDER_TIER_LIMIT = 300  # First 300 users get founder pricing
FOUNDER_TIER_REDIS_KEY = "beatvegas:founder_count"

# Stripe Configuration
STRIPE_CONFIG = {
    "webhook_secret": "whsec_...",  # Set via environment variable
    "customer_portal_url": "/api/stripe/customer-portal",
    "checkout_success_url": "/dashboard?payment=success",
    "checkout_cancel_url": "/billing?payment=cancelled"
}

# Creator Marketplace Revenue Split
CREATOR_REVENUE_SPLIT = {
    "creator_percentage": 70,
    "platform_percentage": 30
}

# Subscription & Report Pricing Limits
CREATOR_PRICING_LIMITS = {
    "subscription_min": 15,
    "subscription_max": 75,
    "report_min": 5,
    "report_max": 50
}

# Compliance: Prohibited Terms
PROHIBITED_TERMS = [
    "bet",
    "wager",
    "guaranteed win",
    "lock",
    "sure thing",
    "can't lose",
    "guaranteed money",
    "betting",
    "gamble",
    "gambling"
]

# Allowed Terms
ALLOWED_TERMS = [
    "forecast",
    "analysis",
    "insight",
    "projection",
    "prediction",
    "outlook",
    "intelligence",
    "assessment"
]

def get_tier_config(tier: str, is_founder: bool = False) -> Dict[str, Any]:
    """Get tier configuration"""
    return TIER_CONFIG.get(tier.lower(), TIER_CONFIG["starter"]).copy()


def get_parlay_price(leg_count: int, tier: str = "starter") -> int:
    """
    Get parlay price in cents for given leg count and tier.
    Universal pricing across all tiers (except internal = free).
    
    Args:
        leg_count: Number of legs (3-6)
        tier: User's tier
        
    Returns:
        Price in cents
    """
    if tier.lower() == "internal":
        return 0  # Internal tier pays nothing
    
    return PARLAY_PRICING.get(f"{leg_count}_leg", 999)


def get_simulation_iterations(tier: str = "starter") -> int:
    """
    Get Monte Carlo simulation iterations for tier.
    
    Args:
        tier: User's tier
        
    Returns:
        Number of iterations
    """
    return SIMULATION_POWER.get(tier.lower(), 10_000)


def should_blur_parlay(tier: str = "starter") -> bool:
    """
    Check if parlays should be blurred for this tier.
    Starter tier sees blurred preview with upgrade prompt.
    
    Args:
        tier: User's tier
        
    Returns:
        True if should show blurred preview only
    """
    return PARLAY_ACCESS.get(tier.lower(), "blur_only") == "blur_only"
            config["price_monthly"] = config["founder_price_monthly"]
        if "founder_price_annual" in config:
            config["price_annual"] = config["founder_price_annual"]
    
    return config

def validate_content(content: str) -> tuple[bool, str]:
    """
    Validate creator content for compliance.
    Returns (is_valid, error_message)
    """
    content_lower = content.lower()
    
    # Check for prohibited terms
    for term in PROHIBITED_TERMS:
        if term in content_lower:
            return False, f"Compliance Error: We sell analysis, not {term}s. Please rephrase your content."
    
    return True, ""

def get_tier_limits(tier: SubscriptionTier) -> Dict[str, int]:
    """Get simulation limits for a tier"""
    config = TIER_CONFIG[tier]
    return {
        "daily_limit": config["simulations_per_day"],
        "monthly_limit": config["simulations_per_month"],
        "iterations": config["iterations"]
    }
